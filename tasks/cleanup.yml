---
# tasks/cleanup.yml

- name: ocStore | Deploy | Enumerate cache files
  find:
    paths: "{{ ocstore_www_root }}/{{ ocstore_shared_dir }}/{{ item.path }}"
    file_type: "any"
    patterns: "{{ item.patterns }}"
    use_regex: True
  with_flattened:
    - "{{ ocstore_shared_cache_path }}"
  register: ocstore_cache_files
  when: ocstore_shared_cache_clean is defined and ocstore_shared_cache_clean == "yes"
  no_log: True

- name: ocStore | Deploy | Delete cache files
  file:
    path: "{{ item.1.path }}"
    state: absent
  with_subelements:
     - "{{ ocstore_cache_files.results }}"
     - files
  when: ocstore_shared_cache_clean is defined and ocstore_shared_cache_clean == "yes"
  no_log: True

- name: ocStore | Deploy | Enumerate log files
  find:
    paths: "{{ ocstore_www_root }}/{{ ocstore_shared_dir }}/{{ item.path }}"
    file_type: "any"
    patterns: "{{ item.patterns }}"
    use_regex: True
  with_flattened:
    - "{{ ocstore_shared_log_path }}"
  register: ocstore_log_files
  when: ocstore_shared_log_clean is defined and ocstore_shared_log_clean == "yes"
  no_log: True  

- name: ocStore | Deploy | Delete log files
  file:
    path: "{{ item.1.path }}"
    state: absent
  with_subelements:
     - "{{ ocstore_log_files.results }}"
     - files
  when: ocstore_shared_log_clean is defined and ocstore_shared_log_clean == "yes"
  no_log: True

- name: ocStore | Deploy | Clean up releases
  shell: ls -1dt {{ ocstore_www_root }}/{{ ocstore_releases_dir }}/* | tail -n +{{ ocstore_keep_releases | int + 1 }} | xargs rm -rf
  when: ocstore_keep_releases > 0
