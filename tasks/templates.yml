---
# tasks/templates.yml

- name: ocStore | Deploy | Ensure template files are exist in current release admin folder
  template: >
    src="admin/{{ item.path }}.j2"
    dest="{{ ocstore_current_release_dir }}/{{ ocstore_admin_dir }}/{{ item.path }}"
    group="{{ ocstore_www_owner_group }}"
    owner="{{ ocstore_www_owner_user }}"
  with_flattened:
    - "{{ ocstore_admin_template_files }}"

- name: ocStore | Deploy | Ensure template files are exist in current release public folder
  template: >
    src="{{ item.path }}.j2"
    dest="{{ ocstore_current_release_dir }}/{{ ocstore_public_dir }}/{{ item.path }}"
    group="{{ ocstore_www_owner_group }}"
    owner="{{ ocstore_www_owner_user }}"
  with_flattened:
    - "{{ ocstore_public_template_files }}"

- name: ocStore | Deploy | Ensure copy files are exist in current release admin and public folder
  copy: >
    src="{{ playbook_dir }}/inventories/deploy/all/files/{{ inventory_hostname }}/files/{{ item.path }}"
    dest="{{ ocstore_current_release_dir }}/{{ item.path }}"
    mode="{{ item.mode }}"
    group="{{ ocstore_www_owner_group }}"
    owner="{{ ocstore_www_owner_user }}"
  with_flattened:
    - "{{ ocstore_release_copy_files }}"

- name: ocStore | Deploy | Ensure all shared folders are exist
  file:
    state: "directory"
    path: "{{ ocstore_www_root }}/{{ ocstore_shared_dir }}/{{ item.path }}"
    group: "{{ ocstore_www_owner_group }}"
    owner: "{{ ocstore_www_owner_user }}"
  with_flattened:
    - "{{ ocstore_shared_folders }}"
    
- name: ocStore | Deploy | Ensure copy files are exist in current shared folder
  copy: >
    src="{{ playbook_dir }}/inventories/deploy/all/files/{{ inventory_hostname }}/files/{{ item.path }}"
    dest="{{ ocstore_www_root }}/{{ ocstore_shared_dir }}/{{ item.path }}"
    mode="{{ item.mode }}"
    group="{{ ocstore_www_owner_group }}"
    owner="{{ ocstore_www_owner_user }}"
  with_flattened:
    - "{{ ocstore_shared_copy_files }}"

- name: ocStore | Deploy | Ensure shared template common files are exist in shared folder once
  template: >
    src="{{ item.path }}.j2"
    dest="{{ ocstore_www_root }}/{{ ocstore_shared_dir }}/{{ item.path }}"
    group="{{ ocstore_www_owner_group }}"
    owner="{{ ocstore_www_owner_user }}"
  with_flattened:
    - "{{ ocstore_shared_template_common_files }}"
  when: ocstore_shared_path.stat.isdir is not defined or not ocstore_shared_path.stat.isdir

- name: ocStore | Deploy | Ensure shared template common stub files are exist in shared folder
  copy: >
    content=""
    force="no"
    dest="{{ ocstore_www_root }}/{{ ocstore_shared_dir }}/{{ item.path }}"
    group="{{ ocstore_www_owner_group }}"
    owner="{{ ocstore_www_owner_user }}"
  with_flattened:
    - "{{ ocstore_shared_template_common_stub_files }}"
